
#include <stdbool.h>
#include <string.h>
#include <stdlib.h>
#include <signal.h>
#include <stdio.h>
#include <errno.h>

#include <enet/enet.h>

volatile sig_atomic_t stop = 0;
void sigint_handle(int signum)
{
	if (signum == SIGINT)
		stop = 1;
	return;
}

int main(int argc, char **argv)
{
	signal(SIGINT, sigint_handle);
	
	ENetHost *client;
	client = enet_host_create(NULL, 1, 2, 0, 0);
	if (client == NULL) {
		fprintf(stderr, "Error while trying to create an ENet client host.\n");
		exit(EXIT_FAILURE);
	}
	ENetAddress address;
	ENetEvent event;
	ENetPeer *peer;
	
	enet_address_set_host(&address, "127.0.0.1");
	if (argc >= 2)
		address.port = atoi(argv[1]);
	else return -1;
	
	peer = enet_host_connect(client, &address, 2, 0);
	if (peer == NULL) {
		fprintf(stderr, "no available peers for initializing an ENet connection.\n");
		exit(EXIT_FAILURE);
	}
	if (enet_host_service(client, &event, 5000) > 0 && event.type == ENET_EVENT_TYPE_CONNECT) {
		puts("Connection succeeded.");
		
		const char *message = "That's a packet sent by the client";
		ENetPacket *packet = enet_packet_create(message, strlen(message) + 1, ENET_PACKET_FLAG_RELIABLE);
		enet_peer_send(peer, 0, packet);
		enet_host_flush(client);
	} else {
		enet_peer_reset(peer);
		puts("Connection failed.");
	}
	
	enet_peer_disconnect(peer, 0);
	char buffer[256]; int check;
	while(!stop && check >= 0) {
		check = enet_host_service(client, &event, 3000);
		if (check > 0) {
			switch(event.type) {
				case ENET_EVENT_TYPE_CONNECT:
					puts("Connection succeeded.");
					
					const char *message = argv[2] ? argv[2] : "that's a packet sent by the client";
					ENetPacket *packet = enet_packet_create(message, strlen(message) + 1, ENET_PACKET_FLAG_RELIABLE);
					enet_peer_
					
				case ENET_EVENT_TYPE_RECEIVE:
					sprintf(buffer, "Server %d says %s", event.peer->incomingPeerID, event.packet->data);
					printf("%s\n", buffer);
					
					enet_packet_destroy(event.packet);
					break;
				case ENET_EVENT_TYPE_DISCONNECT:
					puts("Disconnection succeeded.");
					enet_host_destroy(client);
					return 0;
			}
		}
	}
//	while (enet_host_service(client, &event, 3000) > 0) {
//		switch(event.type) {
//			case ENET_EVENT_TYPE_RECEIVE:
//				sprintf(buffer, "Server %d says %s", event.peer->incomingPeerID, event.packet->data);
//				printf("%s\n", buffer);
//				
//				enet_packet_destroy(event.packet);
//				break;
//			case ENET_EVENT_TYPE_DISCONNECT:
//				puts("Disconnection succeeded.");
//				enet_host_destroy(client);
//				return 0;
//		}
//	}
	enet_peer_reset(peer);
	return -1;
}
